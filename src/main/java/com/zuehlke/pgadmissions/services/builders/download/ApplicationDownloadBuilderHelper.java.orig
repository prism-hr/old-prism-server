package com.zuehlke.pgadmissions.services.builders.download;

import static com.itextpdf.text.Element.ALIGN_LEFT;
import static com.zuehlke.pgadmissions.domain.definitions.PrismDisplayProperty.SYSTEM_VALUE_NOT_PROVIDED;
import static com.zuehlke.pgadmissions.services.builders.download.ApplicationDownloadBuilderConfiguration.PAGE_WIDTH;
import static com.zuehlke.pgadmissions.services.builders.download.ApplicationDownloadBuilderConfiguration.ApplicationDownloadBuilderFontSize.LARGE;
import static org.springframework.beans.factory.config.BeanDefinition.SCOPE_PROTOTYPE;

import java.io.IOException;
import java.io.OutputStream;
import java.net.MalformedURLException;

import org.apache.commons.lang.StringUtils;
import org.apache.commons.lang3.text.WordUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.ApplicationContext;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.itextpdf.text.BadElementException;
import com.itextpdf.text.Chunk;
import com.itextpdf.text.Document;
import com.itextpdf.text.DocumentException;
import com.itextpdf.text.Image;
import com.itextpdf.text.PageSize;
import com.itextpdf.text.Paragraph;
import com.itextpdf.text.Phrase;
import com.itextpdf.text.pdf.PdfPCell;
import com.itextpdf.text.pdf.PdfPTable;
import com.itextpdf.text.pdf.PdfWriter;
import com.zuehlke.pgadmissions.domain.application.Application;
import com.zuehlke.pgadmissions.domain.user.User;
import com.zuehlke.pgadmissions.services.builders.download.ApplicationDownloadBuilderConfiguration.ApplicationDownloadBuilderColor;
import com.zuehlke.pgadmissions.services.builders.download.ApplicationDownloadBuilderConfiguration.ApplicationDownloadBuilderFontSize;
import com.zuehlke.pgadmissions.services.helpers.PropertyLoader;
import com.zuehlke.pgadmissions.utils.ReflectionUtils;

@Service
@Transactional
@Scope(SCOPE_PROTOTYPE)
public class ApplicationDownloadBuilderHelper {

    @Value("${xml.export.logo.file.location}")
    private String logoFileLocation;

    @Value("${xml.export.logo.file.width.percentage}")
    private Float logoFileWidthPercentage;

    @Autowired
    private ApplicationContext applicationContext;

    public Document startDocument() {
        return new Document(PageSize.A4, 50, 50, 100, 50);
    }

    public PdfWriter startDocumentWriter(final OutputStream outputStream, Document pdfDocument) throws DocumentException {
        PdfWriter pdfWriter = PdfWriter.getInstance(pdfDocument, outputStream);
        pdfWriter.setCloseStream(false);
        pdfDocument.open();
        return pdfWriter;
    }

    public PdfPTable startSection(Application application, User user, Document pdfDocument, String title) throws DocumentException {
        pdfDocument.add(newSectionHeader(application, user, title));
        pdfDocument.add(newSectionSeparator());
        return newSectionBody();
    }

    public PdfPTable startSubection(Application application, User user, Document pdfDocument, String title) throws DocumentException {
        PdfPTable subBody = newSectionBody();
        PdfPCell header = new PdfPCell(newSubsectionHeader(application, user, title));
        header.setColspan(2);
        subBody.addCell(header);
        return subBody;
    }

    public void addContentRow(Application application, User user, String title, String content, ApplicationDownloadBuilderFontSize fontSize, PdfPTable table) {
        String fontSizePostfix = WordUtils.capitalizeFully(fontSize.name());
        table.addCell((PdfPCell) ReflectionUtils.invokeMethod(this, "newTitleCell" + fontSizePostfix, title));
        table.addCell((PdfPCell) ReflectionUtils.invokeMethod(this, "newContentCell" + fontSizePostfix,
                content == null ? applicationContext.getBean(PropertyLoader.class).localize(application, user).load(SYSTEM_VALUE_NOT_PROVIDED) : content));
    }

    public void closeSection(Document pdfDocument, PdfPTable body) throws DocumentException {
        pdfDocument.add(body);
        pdfDocument.add(newSectionSeparator());
    }

    public Image newLogoImage() throws BadElementException, MalformedURLException, IOException {
        Image image = Image.getInstance(this.getClass().getResource(logoFileLocation));
        image.setWidthPercentage(logoFileWidthPercentage);
        return image;
    }

    public Paragraph newSectionSeparator() {
        return new Paragraph(" ");
    }

    public PdfPTable newSectionHeader(Application application, User user, String title) {
        return newSectionHeader(application, user, title.toUpperCase(), ApplicationDownloadBuilderColor.GREY);
    }

    public PdfPTable newSubsectionHeader(Application application, User user, String title) {
        return newSectionHeader(application, user, WordUtils.capitalizeFully(title), ApplicationDownloadBuilderColor.WHITE);
    }

    public PdfPTable newSectionBody() {
        PdfPTable table = new PdfPTable(2);
        table.setWidthPercentage(ApplicationDownloadBuilderConfiguration.PAGE_WIDTH);
        return table;
    }

    public PdfPCell newTitleCellSmall(Application application, User user, String content) {
        return newTitleCell(application, user, content, ApplicationDownloadBuilderFontSize.SMALL);
    }

    public PdfPCell newTitleCellMedium(Application application, User user, String content) {
        return newTitleCell(application, user, content, ApplicationDownloadBuilderFontSize.MEDIUM);
    }

    public PdfPCell newTitleCellLarge(Application application, User user, String content) {
        return newTitleCell(application, user, content, ApplicationDownloadBuilderFontSize.LARGE);
    }

    public PdfPCell newContentCellSmall(Application application, User user, String content) {
        return newContentCell(application, user, content, ApplicationDownloadBuilderFontSize.SMALL);
    }

    public PdfPCell newContentCellMedium(Application application, User user, String content) {
        return newContentCell(application, user, content, ApplicationDownloadBuilderFontSize.MEDIUM);
    }

    public PdfPCell newContentCellLarge(Application application, User user, String content) {
        return newContentCell(application, user, content, ApplicationDownloadBuilderFontSize.LARGE);
    }

    public PdfPCell newBookmarkCellSmall(Application application, User user, String content, int index) {
        return newBookmarkCell(application, user, content, ApplicationDownloadBuilderFontSize.SMALL, index);
    }

    public PdfPCell newBookmarkCellMedium(Application application, User user, String content, int index) {
        return newBookmarkCell(application, user, content, ApplicationDownloadBuilderFontSize.MEDIUM, index);
    }

    public PdfPCell newBookmarkCellLarge(Application application, User user, String content, int index) {
        return newBookmarkCell(application, user, content, ApplicationDownloadBuilderFontSize.LARGE, index);
    }

    public PdfPCell newContentCell(Application application, User user, String content, ApplicationDownloadBuilderFontSize fontSize) {
        return newTableCell(application, user, content, fontSize, null);
    }

    public PdfPCell newTitleCell(Application application, User user, String content, ApplicationDownloadBuilderFontSize fontSize) {
        if (content == null) {
            throw new Error();
        }
        return newTableCell(application, user, content, fontSize, null);
    }

    public PdfPCell newBookmarkCell(Application application, User user, String content, ApplicationDownloadBuilderFontSize fontSize, int bookmarkIndex) {
        return newTableCell(application, user, content, fontSize, bookmarkIndex);
    }

    public void addContentRowSmall(Application application, User user, String title, String content, PdfPTable table) {
        addContentRow(application, user, title, content, ApplicationDownloadBuilderFontSize.SMALL, table);
    }

    public void addContentRowMedium(Application application, User user, String title, String content, PdfPTable table) {
        addContentRow(application, user, title, content, ApplicationDownloadBuilderFontSize.MEDIUM, table);
    }

    private PdfPTable newSectionHeader(Application application, User user, String title, ApplicationDownloadBuilderColor background) {
        PdfPTable table = new PdfPTable(1);
        table.setWidthPercentage(PAGE_WIDTH);
        PdfPCell cell = newTableCell(application, user, title, LARGE, null);
        cell.setBackgroundColor(background.getColor());
        table.addCell(cell);
        return table;
    }

    private PdfPCell newTableCell(Application application, User user, String content, ApplicationDownloadBuilderFontSize fontSize, Integer bookmarkIndex) {
        if (fontSize == null) {
            throw new Error();
        }

        Phrase phrase;
        if (StringUtils.isBlank(content)) {
            phrase = new Phrase(applicationContext.getBean(PropertyLoader.class).localize(application, user).load(SYSTEM_VALUE_NOT_PROVIDED),
                    ApplicationDownloadBuilderConfiguration.getEmptyFont(fontSize));
        } else if (bookmarkIndex == null) {
            phrase = new Phrase(content, ApplicationDownloadBuilderConfiguration.getFont(fontSize));
        } else {
            phrase = new Phrase(new Chunk(content, ApplicationDownloadBuilderConfiguration.getLinkFont(fontSize)).setLocalDestination(bookmarkIndex.toString()));
        }

        PdfPCell cell = new PdfPCell(phrase);
        cell.setHorizontalAlignment(ALIGN_LEFT);
        return cell;
    }

}
